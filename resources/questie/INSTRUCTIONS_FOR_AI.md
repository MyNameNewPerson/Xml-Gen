# Техническое задание и Архитектура: Quester Profile Generator (TBC 2.4.3)

## Обзор задачи
Создать универсальное приложение для генерации профилей WRobot (WoW TBC 2.4.3), которое позволяет комбинировать выполнение квестов и «умный гринд» (прокачка на мобах до определенного уровня) в рамках одной или нескольких зон.

## Основные требования к функционалу

### 1. Гибридная логика (Квесты + Гринд)
- Пользователь может выбрать несколько квестов в локации.
- После выполнения квестов (или параллельно) бот должен переходить в режим гринда в указанных точках (Hotspots).
- Гринд должен продолжаться до достижения заданного уровня (`TargetLevel`), после чего бот переходит к следующим задачам.
- Реализация в XML через `CanCondition` с использованием C# Legacy Mode:
  `return ObjectManager.Me.Level >= MinLevel && ObjectManager.Me.Level < TargetLevel;`

### 2. Многозональность и Сохранение данных
- Интерфейс на базе вкладок (`ttk.Notebook`), где каждая вкладка — это отдельная локация.
- Данные между вкладками не должны затираться.
- **Persistence:** Автоматическое сохранение всего проекта в `project.json` при закрытии программы и загрузка при старте. Сохраняются выбранные квесты, настройки гринда, точки перемещения и флаги логистики.

### 3. Управление координатами и навигацией
- **Vector3 Parser:** Парсинг координат из логов WRobot в форматах XML (`<Vector3 ... />`), C# (`new Vector3(...)`) или простого текста.
- **RunTo Points:** Возможность добавлять произвольные точки перемещения для организации путей между квестами, гриндом и важными объектами (флай-мастера, порталы).

### 4. Глобальная логистика (NPC)
- **Дедупликация:** Все NPC (вендоры, тренеры, мастера полетов) должны собираться в единый реестр и записываться в секцию `<Npc>` XML-профиля без дубликатов.
- **Авто-подбор:**
    - Вендоры: Поиск ремонтников и торговцев внутри границ текущей зоны.
    - Полеты: Поиск мастеров полетов на всем континенте ( Azeroth/Kalimdor/Outland).
    - Тренеры: Поиск учителей классов на континенте.

### 5. UI/UX
- Использование `ttkbootstrap` для современного внешнего вида.
- Дерево квестов с поддержкой цепочек.
- Правый клик по квесту: Открытие окна с подробным описанием целей (`Objectives`) и деталей (`Details`) квеста из БД.

---

## Архитектура проекта

### 1. Модели данных (`core/models.py`)
- `ZoneSession`: Хранит ID зоны, список ID выбранных квестов, объект `GrindSettings`, список `RunTo` точек и флаги логистики.
- `GrindSettings`: ID моба, Название, Мин/Макс уровень, список `Hotspot`.
- `RunTo`: Координаты X, Y, Z и название точки.

### 2. Слой данных (`data_access/`)
- `quests_repo.py`: Запросы к `quest_template` для получения списка квестов и их деталей.
- `npc_repo.py`: Поиск NPC по флагам (Vendor, Repair, FlightMaster, Trainer) с фильтрацией по координатам/картам.
- `spawns_repo.py`: Получение координат спавна из Questie (LUA) или напрямую из БД.

### 3. Логика и Экспорт (`logic/`, `exporter/`)
- `session_manager.py`: Управление списком сессий, сериализация в JSON.
- `npc_registry.py`: Синглтон-реестр для накопления уникальных NPC при генерации XML.
- `easy_quest_xml.py`: Основной движок генерации. Должен собирать данные из всех вкладок и формировать блоки `<QuestsSorted>`, `<NpcQuest>`, `<Npc>` и `<EasyQuests>`.

---

## Важные правила для C# (WRobot Legacy Mode)
При генерации любого C# кода (скрипты, условия) **ОБЯЗАТЕЛЬНО** соблюдать стандарт C# 2.0:
- ❌ Никаких `var`. Используйте явные типы (`int`, `string`, `List<...>`).
- ❌ Никаких лямбда-выражений и LINQ (`list.Where(...)`).
- ❌ Никакой интерполяции строк (`$"{val}"`). Используйте `string.Format` или конкатенацию.
- ❌ Никаких `out var` в вызовах методов. Объявляйте переменную заранее.
- ❌ Никаких авто-свойств `{ get; set; }`. Используйте полные поля и свойства.
- ⚠️ **Особенности парсинга:** Не используйте `int.TryParse(str, out int result)`. Используйте:
  ```csharp
  int result;
  int.TryParse(str, out result);
  ```

---

## Инструкции для реализации (Checklist)
1. [ ] Убедиться, что `ZoneSession` корректно восстанавливается из JSON.
2. [ ] Проверить, что `NPCRegistry` очищается перед каждой генерацией XML.
3. [ ] Реализовать цикл по всем сессиям в `generate_easy_quest_xml`.
4. [ ] Добавить в XML блок `CanCondition` для гринда, учитывающий `min_level`.
5. [ ] Добавить в XML действия `RunTo` для каждой точки из списка `run_to_points`.
6. [ ] Обеспечить, чтобы `map_id` определялся корректно даже если в зоне не выбрано ни одного квеста.
